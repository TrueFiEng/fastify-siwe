{"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/plugin.ts":{"path":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/plugin.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":0},"end":{"line":3,"column":68}},"2":{"start":{"line":4,"column":15},"end":{"line":4,"column":30}},"3":{"start":{"line":5,"column":18},"end":{"line":5,"column":38}},"4":{"start":{"line":6,"column":25},"end":{"line":6,"column":50}},"5":{"start":{"line":7,"column":24},"end":{"line":7,"column":50}},"6":{"start":{"line":8,"column":27},"end":{"line":34,"column":20}},"7":{"start":{"line":8,"column":85},"end":{"line":34,"column":20}},"8":{"start":{"line":9,"column":4},"end":{"line":13,"column":7}},"9":{"start":{"line":10,"column":8},"end":{"line":12,"column":9}},"10":{"start":{"line":11,"column":12},"end":{"line":11,"column":111}},"11":{"start":{"line":14,"column":4},"end":{"line":33,"column":7}},"12":{"start":{"line":15,"column":8},"end":{"line":15,"column":52}},"13":{"start":{"line":16,"column":22},"end":{"line":16,"column":58}},"14":{"start":{"line":17,"column":8},"end":{"line":32,"column":9}},"15":{"start":{"line":18,"column":12},"end":{"line":31,"column":13}},"16":{"start":{"line":19,"column":36},"end":{"line":19,"column":70}},"17":{"start":{"line":20,"column":39},"end":{"line":20,"column":73}},"18":{"start":{"line":21,"column":16},"end":{"line":23,"column":17}},"19":{"start":{"line":22,"column":20},"end":{"line":22,"column":109}},"20":{"start":{"line":24,"column":16},"end":{"line":26,"column":17}},"21":{"start":{"line":25,"column":20},"end":{"line":25,"column":107}},"22":{"start":{"line":27,"column":16},"end":{"line":27,"column":51}},"23":{"start":{"line":30,"column":16},"end":{"line":30,"column":99}},"24":{"start":{"line":35,"column":0},"end":{"line":35,"column":48}},"25":{"start":{"line":37,"column":35},"end":{"line":37,"column":52}},"26":{"start":{"line":38,"column":24},"end":{"line":38,"column":55}},"27":{"start":{"line":39,"column":4},"end":{"line":39,"column":44}},"28":{"start":{"line":40,"column":4},"end":{"line":40,"column":19}},"29":{"start":{"line":42,"column":0},"end":{"line":42,"column":54}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":8,"column":27},"end":{"line":8,"column":28}},"loc":{"start":{"line":8,"column":85},"end":{"line":34,"column":20}},"line":8},"1":{"name":"(anonymous_1)","decl":{"start":{"line":8,"column":115},"end":{"line":8,"column":116}},"loc":{"start":{"line":8,"column":134},"end":{"line":34,"column":1}},"line":8},"2":{"name":"(anonymous_2)","decl":{"start":{"line":9,"column":31},"end":{"line":9,"column":32}},"loc":{"start":{"line":9,"column":43},"end":{"line":13,"column":5}},"line":9},"3":{"name":"(anonymous_3)","decl":{"start":{"line":14,"column":34},"end":{"line":14,"column":35}},"loc":{"start":{"line":14,"column":60},"end":{"line":33,"column":5}},"line":14},"4":{"name":"parseAndValidateToken","decl":{"start":{"line":36,"column":15},"end":{"line":36,"column":36}},"loc":{"start":{"line":36,"column":44},"end":{"line":41,"column":1}},"line":36}},"branchMap":{"0":{"loc":{"start":{"line":8,"column":28},"end":{"line":8,"column":80}},"type":"default-arg","locations":[{"start":{"line":8,"column":78},"end":{"line":8,"column":80}}],"line":8},"1":{"loc":{"start":{"line":8,"column":30},"end":{"line":8,"column":73}},"type":"default-arg","locations":[{"start":{"line":8,"column":38},"end":{"line":8,"column":73}}],"line":8},"2":{"loc":{"start":{"line":10,"column":8},"end":{"line":12,"column":9}},"type":"if","locations":[{"start":{"line":10,"column":8},"end":{"line":12,"column":9}},{"start":{"line":10,"column":8},"end":{"line":12,"column":9}}],"line":10},"3":{"loc":{"start":{"line":17,"column":8},"end":{"line":32,"column":9}},"type":"if","locations":[{"start":{"line":17,"column":8},"end":{"line":32,"column":9}},{"start":{"line":17,"column":8},"end":{"line":32,"column":9}}],"line":17},"4":{"loc":{"start":{"line":21,"column":16},"end":{"line":23,"column":17}},"type":"if","locations":[{"start":{"line":21,"column":16},"end":{"line":23,"column":17}},{"start":{"line":21,"column":16},"end":{"line":23,"column":17}}],"line":21},"5":{"loc":{"start":{"line":24,"column":16},"end":{"line":26,"column":17}},"type":"if","locations":[{"start":{"line":24,"column":16},"end":{"line":26,"column":17}},{"start":{"line":24,"column":16},"end":{"line":26,"column":17}}],"line":24}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":0,"11":1,"12":22,"13":22,"14":22,"15":7,"16":7,"17":6,"18":6,"19":1,"20":5,"21":3,"22":2,"23":1,"24":1,"25":14,"26":14,"27":14,"28":11,"29":1},"f":{"0":1,"1":1,"2":1,"3":22,"4":14},"b":{"0":[0],"1":[0],"2":[0,1],"3":[7,15],"4":[1,5],"5":[3,2]},"inputSourceMap":{"version":3,"file":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/plugin.ts","sources":["/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/plugin.ts"],"names":[],"mappings":";;;AACA,+BAAkC;AAClC,uCAAmC;AAEnC,mDAA0C;AAE1C,mDAA+C;AAMxC,MAAM,kBAAkB,GAAG,CAAC,EAAE,KAAK,GAAG,IAAI,6BAAa,EAAE,KAAyB,EAAE,EAAE,EAAE,CAC7F,IAAA,wBAAa,EACX,KAAK,EAAE,OAAwB,EAAE,EAAE;IACjC,OAAO,CAAC,OAAO,CAAC,SAAS,EAAE,KAAK,IAAI,EAAE;QACpC,IAAI,CAAC,OAAO,CAAC,WAAW,EAAE;YACxB,MAAM,IAAI,KAAK,CAAC,iFAAiF,CAAC,CAAA;SACnG;IACH,CAAC,CAAC,CAAA;IAEF,OAAO,CAAC,OAAO,CAAC,YAAY,EAAE,KAAK,EAAE,OAAuB,EAAE,KAAmB,EAAE,EAAE;QACnF,OAAO,CAAC,IAAI,GAAG,IAAI,iBAAO,CAAC,KAAK,CAAC,CAAA;QACjC,MAAM,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,mBAAmB,CAAC,CAAA;QAClD,IAAI,KAAK,EAAE;YACT,IAAI;gBACF,MAAM,WAAW,GAAG,MAAM,qBAAqB,CAAC,KAAK,CAAC,CAAA;gBAEtD,MAAM,cAAc,GAAG,MAAM,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,KAAK,CAAC,CAAA;gBACzD,IAAI,CAAC,cAAc,EAAE;oBACnB,OAAO,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC,IAAI,CAAC,wBAAwB,CAAC,CAAA;iBACzF;gBACD,IAAI,WAAW,CAAC,OAAO,KAAK,cAAc,CAAC,OAAO,EAAE,OAAO,EAAE;oBAC3D,OAAO,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC,IAAI,CAAC,sBAAsB,CAAC,CAAA;iBACvF;gBAED,OAAO,CAAC,IAAI,CAAC,OAAO,GAAG,WAAW,CAAA;aACnC;YAAC,OAAO,GAAG,EAAE;gBACZ,KAAK,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAA;aACnF;SACF;IACH,CAAC,CAAC,CAAA;AACJ,CAAC,EACD,EAAE,IAAI,EAAE,MAAM,EAAE,CACjB,CAAA;AAhCU,QAAA,kBAAkB,sBAgC5B;AAEI,KAAK,UAAU,qBAAqB,CAAC,KAAa;IACvD,MAAM,EAAE,OAAO,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAA;IAEhD,MAAM,WAAW,GAAG,IAAI,kBAAW,CAAC,OAAO,CAAC,CAAA;IAE5C,MAAM,WAAW,CAAC,MAAM,CAAC,EAAE,SAAS,EAAE,CAAC,CAAA;IAEvC,OAAO,OAAO,CAAA;AAChB,CAAC;AARD,sDAQC","sourcesContent":["import type { FastifyInstance, FastifyReply, FastifyRequest } from 'fastify'\nimport { SiweMessage } from 'siwe'\nimport { SiweApi } from './SiweApi'\nimport { SessionStore } from './types'\nimport fastifyPlugin from 'fastify-plugin'\nimport type {} from '@fastify/cookie' // Has to be there in order to override the Fastify types with cookies.\nimport { InMemoryStore } from './InMemoryStore'\n\nexport interface FastifySiweOptions {\n  store?: SessionStore\n}\n\nexport const signInWithEthereum = ({ store = new InMemoryStore() }: FastifySiweOptions = {}) =>\n  fastifyPlugin(\n    async (fastify: FastifyInstance) => {\n      fastify.addHook('onReady', async () => {\n        if (!fastify.parseCookie) {\n          throw new Error('@fastify/cookie is not registered. Please register it before using fastify-siwe')\n        }\n      })\n\n      fastify.addHook('preHandler', async (request: FastifyRequest, reply: FastifyReply) => {\n        request.siwe = new SiweApi(store)\n        const token = request.cookies['__Host_auth_token']\n        if (token) {\n          try {\n            const siweMessage = await parseAndValidateToken(token)\n\n            const currentSession = await store.get(siweMessage.nonce)\n            if (!currentSession) {\n              return reply.status(403).clearCookie('__Host_auth_token').send('Session does not exist')\n            }\n            if (siweMessage.address !== currentSession.message?.address) {\n              return reply.status(403).clearCookie('__Host_auth_token').send('Invalid SIWE address')\n            }\n\n            request.siwe.session = siweMessage\n          } catch (err) {\n            void reply.status(401).clearCookie('__Host_auth_token').send('Invalid SIWE token')\n          }\n        }\n      })\n    },\n    { name: 'SIWE' }\n  )\n\nexport async function parseAndValidateToken(token: string): Promise<SiweMessage> {\n  const { message, signature } = JSON.parse(token)\n\n  const siweMessage = new SiweMessage(message)\n\n  await siweMessage.verify({ signature })\n\n  return message\n}\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"49d08170fc0ce8b4c5bac57772db489e1328ca30","contentHash":"077e5158b001952ab78d5a3f414a0191c16d92b158f81ebd1a03b5649f47286b"},"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/SiweApi.ts":{"path":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/SiweApi.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":0},"end":{"line":3,"column":25}},"2":{"start":{"line":4,"column":15},"end":{"line":4,"column":30}},"3":{"start":{"line":8,"column":8},"end":{"line":8,"column":29}},"4":{"start":{"line":12,"column":22},"end":{"line":12,"column":49}},"5":{"start":{"line":13,"column":8},"end":{"line":15,"column":11}},"6":{"start":{"line":16,"column":8},"end":{"line":16,"column":21}},"7":{"start":{"line":19,"column":31},"end":{"line":19,"column":67}},"8":{"start":{"line":20,"column":8},"end":{"line":22,"column":9}},"9":{"start":{"line":21,"column":12},"end":{"line":21,"column":55}},"10":{"start":{"line":23,"column":8},"end":{"line":25,"column":9}},"11":{"start":{"line":24,"column":12},"end":{"line":24,"column":54}},"12":{"start":{"line":26,"column":8},"end":{"line":29,"column":11}},"13":{"start":{"line":32,"column":8},"end":{"line":34,"column":9}},"14":{"start":{"line":33,"column":12},"end":{"line":33,"column":53}},"15":{"start":{"line":35,"column":8},"end":{"line":35,"column":53}},"16":{"start":{"line":36,"column":8},"end":{"line":36,"column":33}},"17":{"start":{"line":39,"column":0},"end":{"line":39,"column":26}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":7,"column":4},"end":{"line":7,"column":5}},"loc":{"start":{"line":7,"column":24},"end":{"line":9,"column":5}},"line":7},"1":{"name":"(anonymous_1)","decl":{"start":{"line":11,"column":4},"end":{"line":11,"column":5}},"loc":{"start":{"line":11,"column":26},"end":{"line":17,"column":5}},"line":11},"2":{"name":"(anonymous_2)","decl":{"start":{"line":18,"column":4},"end":{"line":18,"column":5}},"loc":{"start":{"line":18,"column":30},"end":{"line":30,"column":5}},"line":18},"3":{"name":"(anonymous_3)","decl":{"start":{"line":31,"column":4},"end":{"line":31,"column":5}},"loc":{"start":{"line":31,"column":27},"end":{"line":37,"column":5}},"line":31}},"branchMap":{"0":{"loc":{"start":{"line":20,"column":8},"end":{"line":22,"column":9}},"type":"if","locations":[{"start":{"line":20,"column":8},"end":{"line":22,"column":9}},{"start":{"line":20,"column":8},"end":{"line":22,"column":9}}],"line":20},"1":{"loc":{"start":{"line":23,"column":8},"end":{"line":25,"column":9}},"type":"if","locations":[{"start":{"line":23,"column":8},"end":{"line":25,"column":9}},{"start":{"line":23,"column":8},"end":{"line":25,"column":9}}],"line":23},"2":{"loc":{"start":{"line":32,"column":8},"end":{"line":34,"column":9}},"type":"if","locations":[{"start":{"line":32,"column":8},"end":{"line":34,"column":9}},{"start":{"line":32,"column":8},"end":{"line":34,"column":9}}],"line":32}},"s":{"0":1,"1":1,"2":1,"3":22,"4":8,"5":8,"6":8,"7":5,"8":5,"9":2,"10":3,"11":1,"12":2,"13":0,"14":0,"15":0,"16":0,"17":1},"f":{"0":22,"1":8,"2":5,"3":0},"b":{"0":[2,3],"1":[1,2],"2":[0,0]},"inputSourceMap":{"version":3,"file":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/SiweApi.ts","sources":["/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/SiweApi.ts"],"names":[],"mappings":";;;AAAA,+BAAiD;AAGjD,MAAa,OAAO;IACW;IAA7B,YAA6B,MAAoB;QAApB,WAAM,GAAN,MAAM,CAAc;IAAG,CAAC;IAE9C,OAAO,CAAc;IAE5B,KAAK,CAAC,aAAa;QACjB,MAAM,KAAK,GAAG,IAAA,oBAAa,GAAE,CAAA;QAC7B,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC;YACrB,KAAK;SACN,CAAC,CAAA;QACF,OAAO,KAAK,CAAA;IACd,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,OAAoB;QACnC,MAAM,cAAc,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,OAAO,CAAC,KAAK,CAAC,CAAA;QAE3D,IAAI,CAAC,cAAc,EAAE;YACnB,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAA;SAC3C;QACD,IAAI,cAAc,CAAC,OAAO,EAAE;YAC1B,MAAM,IAAI,KAAK,CAAC,wBAAwB,CAAC,CAAA;SAC1C;QAED,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC;YACrB,KAAK,EAAE,OAAO,CAAC,KAAK;YACpB,OAAO;SACR,CAAC,CAAA;IACJ,CAAC;IAED,KAAK,CAAC,cAAc;QAClB,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,EAAE;YACxB,MAAM,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAA;SACzC;QAED,MAAM,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,CAAA;QAC5C,IAAI,CAAC,OAAO,GAAG,SAAS,CAAA;IAC1B,CAAC;CACF;AArCD,0BAqCC","sourcesContent":["import { generateNonce, SiweMessage } from 'siwe'\nimport { SessionStore } from './index'\n\nexport class SiweApi {\n  constructor(private readonly _store: SessionStore) {}\n\n  public session?: SiweMessage\n\n  async generateNonce(): Promise<string> {\n    const nonce = generateNonce()\n    await this._store.save({\n      nonce,\n    })\n    return nonce\n  }\n\n  async setMessage(message: SiweMessage): Promise<void> {\n    const currentSession = await this._store.get(message.nonce)\n\n    if (!currentSession) {\n      throw new Error('Session not initialized')\n    }\n    if (currentSession.message) {\n      throw new Error('Session already exists')\n    }\n\n    await this._store.save({\n      nonce: message.nonce,\n      message,\n    })\n  }\n\n  async destroySession(): Promise<void> {\n    if (!this.session?.nonce) {\n      throw new Error('No session to destroy')\n    }\n\n    await this._store.remove(this.session.nonce)\n    this.session = undefined\n  }\n}\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"866e8f4e4e08d8a09f829b3e27258df15fdda6a6","contentHash":"eb29134be76bb01e038c176da505b3fa46f35ac701e34d4a1195ac4c258d5dc9"},"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/InMemoryStore.ts":{"path":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/InMemoryStore.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":0},"end":{"line":3,"column":31}},"2":{"start":{"line":7,"column":8},"end":{"line":7,"column":27}},"3":{"start":{"line":10,"column":8},"end":{"line":10,"column":47}},"4":{"start":{"line":13,"column":8},"end":{"line":13,"column":36}},"5":{"start":{"line":16,"column":8},"end":{"line":16,"column":36}},"6":{"start":{"line":19,"column":0},"end":{"line":19,"column":38}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":6,"column":4},"end":{"line":6,"column":5}},"loc":{"start":{"line":6,"column":18},"end":{"line":8,"column":5}},"line":6},"1":{"name":"(anonymous_1)","decl":{"start":{"line":9,"column":4},"end":{"line":9,"column":5}},"loc":{"start":{"line":9,"column":24},"end":{"line":11,"column":5}},"line":9},"2":{"name":"(anonymous_2)","decl":{"start":{"line":12,"column":4},"end":{"line":12,"column":5}},"loc":{"start":{"line":12,"column":21},"end":{"line":14,"column":5}},"line":12},"3":{"name":"(anonymous_3)","decl":{"start":{"line":15,"column":4},"end":{"line":15,"column":5}},"loc":{"start":{"line":15,"column":24},"end":{"line":17,"column":5}},"line":15}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":10,"4":14,"5":0,"6":1},"f":{"0":1,"1":10,"2":14,"3":0},"b":{},"inputSourceMap":{"version":3,"file":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/InMemoryStore.ts","sources":["/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/InMemoryStore.ts"],"names":[],"mappings":";;;AAEA,MAAa,aAAa;IACjB,QAAQ,CAA+B;IAE9C;QACE,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAA;IACpB,CAAC;IAEM,KAAK,CAAC,IAAI,CAAC,OAAsB;QACtC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,OAAO,CAAA;IACxC,CAAC;IAED,KAAK,CAAC,GAAG,CAAC,KAAa;QACrB,OAAO,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAA;IAC7B,CAAC;IAED,KAAK,CAAC,MAAM,CAAC,KAAa;QACxB,OAAO,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAA;IAC7B,CAAC;CACF;AAlBD,sCAkBC","sourcesContent":["import { SessionStore, StoredSession } from './types'\n\nexport class InMemoryStore implements SessionStore {\n  public sessions: Record<string, StoredSession>\n\n  constructor() {\n    this.sessions = {}\n  }\n\n  public async save(session: StoredSession) {\n    this.sessions[session.nonce] = session\n  }\n\n  async get(nonce: string): Promise<StoredSession | undefined> {\n    return this.sessions[nonce]\n  }\n\n  async remove(nonce: string): Promise<void> {\n    delete this.sessions[nonce]\n  }\n}\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"f3d93b0c19f6e6f07ee85b68ceb2a85b453b4fc4","contentHash":"feee548e2e23dda135e39c1d1ad18943c034b067134deeb63012a06d4687dece"},"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/registerSiweRoutes.ts":{"path":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/registerSiweRoutes.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":0},"end":{"line":3,"column":36}},"2":{"start":{"line":4,"column":17},"end":{"line":4,"column":36}},"3":{"start":{"line":5,"column":20},"end":{"line":10,"column":1}},"4":{"start":{"line":11,"column":27},"end":{"line":51,"column":1}},"5":{"start":{"line":12,"column":4},"end":{"line":16,"column":7}},"6":{"start":{"line":13,"column":8},"end":{"line":15,"column":11}},"7":{"start":{"line":17,"column":4},"end":{"line":36,"column":7}},"8":{"start":{"line":18,"column":39},"end":{"line":18,"column":47}},"9":{"start":{"line":19,"column":22},"end":{"line":19,"column":60}},"10":{"start":{"line":20,"column":8},"end":{"line":26,"column":9}},"11":{"start":{"line":21,"column":12},"end":{"line":21,"column":61}},"12":{"start":{"line":22,"column":12},"end":{"line":22,"column":47}},"13":{"start":{"line":25,"column":12},"end":{"line":25,"column":53}},"14":{"start":{"line":27,"column":8},"end":{"line":35,"column":20}},"15":{"start":{"line":37,"column":4},"end":{"line":45,"column":7}},"16":{"start":{"line":38,"column":8},"end":{"line":40,"column":9}},"17":{"start":{"line":39,"column":12},"end":{"line":39,"column":44}},"18":{"start":{"line":41,"column":8},"end":{"line":44,"column":11}},"19":{"start":{"line":46,"column":4},"end":{"line":49,"column":7}},"20":{"start":{"line":47,"column":8},"end":{"line":47,"column":40}},"21":{"start":{"line":48,"column":8},"end":{"line":48,"column":59}},"22":{"start":{"line":50,"column":4},"end":{"line":50,"column":19}},"23":{"start":{"line":52,"column":0},"end":{"line":52,"column":48}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":11,"column":27},"end":{"line":11,"column":28}},"loc":{"start":{"line":11,"column":60},"end":{"line":51,"column":1}},"line":11},"1":{"name":"handler","decl":{"start":{"line":12,"column":50},"end":{"line":12,"column":57}},"loc":{"start":{"line":12,"column":70},"end":{"line":16,"column":5}},"line":12},"2":{"name":"handler","decl":{"start":{"line":17,"column":52},"end":{"line":17,"column":59}},"loc":{"start":{"line":17,"column":72},"end":{"line":36,"column":5}},"line":17},"3":{"name":"handler","decl":{"start":{"line":37,"column":47},"end":{"line":37,"column":54}},"loc":{"start":{"line":37,"column":67},"end":{"line":45,"column":5}},"line":37},"4":{"name":"handler","decl":{"start":{"line":46,"column":52},"end":{"line":46,"column":59}},"loc":{"start":{"line":46,"column":72},"end":{"line":49,"column":5}},"line":46}},"branchMap":{"0":{"loc":{"start":{"line":11,"column":37},"end":{"line":11,"column":55}},"type":"default-arg","locations":[{"start":{"line":11,"column":44},"end":{"line":11,"column":55}}],"line":11},"1":{"loc":{"start":{"line":38,"column":8},"end":{"line":40,"column":9}},"type":"if","locations":[{"start":{"line":38,"column":8},"end":{"line":40,"column":9}},{"start":{"line":38,"column":8},"end":{"line":40,"column":9}}],"line":38}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":8,"7":1,"8":7,"9":7,"10":7,"11":7,"12":5,"13":5,"14":7,"15":1,"16":2,"17":0,"18":2,"19":1,"20":0,"21":0,"22":1,"23":1},"f":{"0":1,"1":8,"2":7,"3":2,"4":0},"b":{"0":[1],"1":[0,2]},"inputSourceMap":{"version":3,"file":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/registerSiweRoutes.ts","sources":["/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/registerSiweRoutes.ts"],"names":[],"mappings":";;;AAEA,qCAAgD;AAShD,MAAM,WAAW,GAA2B;IAC1C,YAAY,EAAE,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,aAAa;IACpD,cAAc,EAAE,QAAQ;IACxB,YAAY,EAAE,EAAE,GAAG,EAAE,GAAG,EAAE;IAC1B,UAAU,EAAE,GAAG;CAChB,CAAA;AAEM,MAAM,kBAAkB,GAAG,CAAC,OAAwB,EAAE,OAA+B,WAAW,EAAE,EAAE;IACzG,OAAO,CAAC,IAAI,CACV,YAAY,EACZ,EAAE,EACF,KAAK,UAAU,OAAO,CAAwB,GAAmB,EAAE,KAAmB;QACpF,KAAK,KAAK,CAAC,IAAI,CAAC;YACd,KAAK,EAAE,MAAM,GAAG,CAAC,IAAI,CAAC,aAAa,EAAE;SACtC,CAAC,CAAA;IACJ,CAAC,CACF,CAAA;IAED,OAAO,CAAC,IAAI,CACV,cAAc,EACd,EAAE,EACF,KAAK,UAAU,OAAO,CAEpB,GAKE,EACF,KAAmB;QAEnB,MAAM,EAAE,SAAS,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,IAAI,CAAA;QACvC,MAAM,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE,SAAS,EAAE,OAAO,EAAE,CAAC,CAAA;QAEpD,IAAI;YACF,MAAM,IAAA,8BAAqB,EAAC,KAAK,CAAC,CAAA;YAClC,MAAM,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAA;SACnC;QAAC,OAAO,GAAQ,EAAE;YACjB,KAAK,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,CAAA;SACzC;QAED,KAAK,KAAK;aACP,SAAS,CAAC,mBAAmB,EAAE,KAAK,EAAE;YACrC,QAAQ,EAAE,IAAI;YACd,MAAM,EAAE,IAAI,CAAC,YAAY;YACzB,QAAQ,EAAE,IAAI,CAAC,cAAc;YAC7B,MAAM,EAAE,IAAI,CAAC,YAAY;YACzB,IAAI,EAAE,IAAI,CAAC,UAAU;SACtB,CAAC;aACD,IAAI,EAAE,CAAA;IACX,CAAC,CACF,CAAA;IAED,OAAO,CAAC,GAAG,CAAC,UAAU,EAAE,EAAE,EAAE,KAAK,UAAU,OAAO,CAAwB,GAAmB,EAAE,KAAmB;QAChH,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,EAAE;YACrB,OAAO,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,CAAA;SAChC;QAED,KAAK,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YACxB,QAAQ,EAAE,IAAI;YACd,OAAO,EAAE,GAAG,CAAC,IAAI,CAAC,OAAO;SAC1B,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;IAEF,OAAO,CAAC,GAAG,CACT,eAAe,EACf,EAAE,EACF,KAAK,UAAU,OAAO,CAAwB,GAAmB,EAAE,KAAmB;QACpF,MAAM,GAAG,CAAC,IAAI,CAAC,cAAc,EAAE,CAAA;QAC/B,KAAK,KAAK,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC,IAAI,EAAE,CAAA;IACpD,CAAC,CACF,CAAA;IAED,OAAO,OAAO,CAAA;AAChB,CAAC,CAAA;AAnEY,QAAA,kBAAkB,sBAmE9B","sourcesContent":["import type { FastifyInstance, FastifyReply, FastifyRequest } from 'fastify'\nimport { SiweMessage } from 'siwe'\nimport { parseAndValidateToken } from './plugin'\n\nexport interface RegisterSiweRoutesOpts {\n  cookieSecure?: boolean\n  cookieSameSite?: boolean | 'strict' | 'lax' | 'none'\n  cookieMaxAge?: number\n  cookiePath?: string\n}\n\nconst defaultOpts: RegisterSiweRoutesOpts = {\n  cookieSecure: process.env.NODE_ENV !== 'development',\n  cookieSameSite: 'strict',\n  cookieMaxAge: 60 * 60 * 24, // 1 day\n  cookiePath: '/',\n}\n\nexport const registerSiweRoutes = (fastify: FastifyInstance, opts: RegisterSiweRoutesOpts = defaultOpts) => {\n  fastify.post(\n    '/siwe/init',\n    {},\n    async function handler(this: FastifyInstance, req: FastifyRequest, reply: FastifyReply) {\n      void reply.send({\n        nonce: await req.siwe.generateNonce(),\n      })\n    }\n  )\n\n  fastify.post(\n    '/siwe/signin',\n    {},\n    async function handler(\n      this: FastifyInstance,\n      req: FastifyRequest<{\n        Body: {\n          signature: string\n          message: SiweMessage\n        }\n      }>,\n      reply: FastifyReply\n    ) {\n      const { signature, message } = req.body\n      const token = JSON.stringify({ signature, message })\n\n      try {\n        await parseAndValidateToken(token)\n        await req.siwe.setMessage(message)\n      } catch (err: any) {\n        void reply.status(403).send(err.message)\n      }\n\n      void reply\n        .setCookie('__Host_auth_token', token, {\n          httpOnly: true,\n          secure: opts.cookieSecure,\n          sameSite: opts.cookieSameSite,\n          maxAge: opts.cookieMaxAge,\n          path: opts.cookiePath,\n        })\n        .send()\n    }\n  )\n\n  fastify.get('/siwe/me', {}, async function handler(this: FastifyInstance, req: FastifyRequest, reply: FastifyReply) {\n    if (!req.siwe.session) {\n      return reply.status(401).send()\n    }\n\n    void reply.code(200).send({\n      loggedIn: true,\n      message: req.siwe.session,\n    })\n  })\n\n  fastify.get(\n    '/siwe/signout',\n    {},\n    async function handler(this: FastifyInstance, req: FastifyRequest, reply: FastifyReply) {\n      await req.siwe.destroySession()\n      void reply.clearCookie('__Host_auth_token').send()\n    }\n  )\n\n  return fastify\n}\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"67bc1262a3e63fc8dac0814739d60c05ce5b60de","contentHash":"4077955ab1c8c39c9c348d1cff3f3bc39d467be0f92b50969af21e042e03b511"},"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/utils.ts":{"path":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/utils.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":0},"end":{"line":3,"column":112}},"2":{"start":{"line":4,"column":15},"end":{"line":4,"column":30}},"3":{"start":{"line":6,"column":4},"end":{"line":6,"column":77}},"4":{"start":{"line":8,"column":0},"end":{"line":8,"column":28}},"5":{"start":{"line":10,"column":4},"end":{"line":10,"column":112}},"6":{"start":{"line":12,"column":0},"end":{"line":12,"column":24}},"7":{"start":{"line":14,"column":4},"end":{"line":21,"column":7}},"8":{"start":{"line":23,"column":0},"end":{"line":23,"column":26}},"9":{"start":{"line":25,"column":4},"end":{"line":32,"column":6}},"10":{"start":{"line":34,"column":0},"end":{"line":34,"column":46}},"11":{"start":{"line":36,"column":26},"end":{"line":36,"column":45}},"12":{"start":{"line":37,"column":30},"end":{"line":37,"column":60}},"13":{"start":{"line":38,"column":20},"end":{"line":38,"column":45}},"14":{"start":{"line":39,"column":24},"end":{"line":42,"column":6}},"15":{"start":{"line":43,"column":22},"end":{"line":43,"column":76}},"16":{"start":{"line":44,"column":18},"end":{"line":44,"column":69}},"17":{"start":{"line":45,"column":4},"end":{"line":45,"column":30}},"18":{"start":{"line":46,"column":4},"end":{"line":46,"column":17}},"19":{"start":{"line":48,"column":0},"end":{"line":48,"column":36}}},"fnMap":{"0":{"name":"getNonce","decl":{"start":{"line":5,"column":15},"end":{"line":5,"column":23}},"loc":{"start":{"line":5,"column":29},"end":{"line":7,"column":1}},"line":5},"1":{"name":"signIn","decl":{"start":{"line":9,"column":15},"end":{"line":9,"column":21}},"loc":{"start":{"line":9,"column":51},"end":{"line":11,"column":1}},"line":9},"2":{"name":"getAuth","decl":{"start":{"line":13,"column":15},"end":{"line":13,"column":22}},"loc":{"start":{"line":13,"column":35},"end":{"line":22,"column":1}},"line":13},"3":{"name":"createAuthMessage","decl":{"start":{"line":24,"column":9},"end":{"line":24,"column":26}},"loc":{"start":{"line":24,"column":35},"end":{"line":33,"column":1}},"line":24},"4":{"name":"authenticate","decl":{"start":{"line":35,"column":15},"end":{"line":35,"column":27}},"loc":{"start":{"line":35,"column":41},"end":{"line":47,"column":1}},"line":35}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":8,"4":1,"5":7,"6":1,"7":7,"8":1,"9":5,"10":1,"11":2,"12":2,"13":2,"14":2,"15":2,"16":2,"17":2,"18":2,"19":1},"f":{"0":8,"1":7,"2":7,"3":5,"4":2},"b":{},"inputSourceMap":{"version":3,"file":"/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/utils.ts","sources":["/Users/jakub.sieczczynski/repos/fastify-siwe/packages/fastify-siwe/src/utils.ts"],"names":[],"mappings":";;;AAGA,+BAAkC;AAE3B,KAAK,UAAU,QAAQ,CAAC,GAAoB;IACjD,OAAO,GAAG,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,EAAE,YAAY,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC,CAAA;AAC1E,CAAC;AAFD,4BAEC;AAEM,KAAK,UAAU,MAAM,CAC1B,GAAoB,EACpB,EAAE,SAAS,EAAE,OAAO,EAA+C;IAEnE,OAAO,GAAG,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,EAAE,cAAc,EAAE,OAAO,EAAE,EAAE,SAAS,EAAE,OAAO,EAAE,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC,CAAA;AAC7G,CAAC;AALD,wBAKC;AAEM,KAAK,UAAU,OAAO,CAAC,GAAoB,EAAE,KAAa;IAC/D,OAAO,GAAG,CAAC,MAAM,CAAC;QAChB,MAAM,EAAE,KAAK;QACb,GAAG,EAAE,UAAU;QACf,QAAQ,EAAE,IAAI;QACd,OAAO,EAAE;YACP,iBAAiB,EAAE,KAAK;SACzB;KACF,CAAC,CAAA;AACJ,CAAC;AATD,0BASC;AAED,SAAgB,iBAAiB,CAAC,MAAc;IAC9C,OAAO;QACL,MAAM,EAAE,gBAAgB;QACxB,OAAO,EAAE,MAAM,CAAC,OAAO;QACvB,SAAS,EAAE,mCAAmC;QAC9C,GAAG,EAAE,uBAAuB;QAC5B,OAAO,EAAE,GAAG;QACZ,OAAO,EAAE,CAAC;KACX,CAAA;AACH,CAAC;AATD,8CASC;AAEM,KAAK,UAAU,YAAY,CAAC,MAAc,EAAE,GAAoB;IACrE,MAAM,aAAa,GAAG,MAAM,QAAQ,CAAC,GAAG,CAAC,CAAA;IACzC,MAAM,iBAAiB,GAAG,IAAI,CAAC,KAAK,CAAC,aAAa,CAAC,IAAI,CAAC,CAAA;IACxD,MAAM,OAAO,GAAG,iBAAiB,CAAC,MAAM,CAAC,CAAA;IAEzC,MAAM,WAAW,GAAG,IAAI,kBAAW,CAAC;QAClC,GAAG,OAAO;QACV,KAAK,EAAE,iBAAiB,CAAC,KAAK;KAC/B,CAAC,CAAA;IAEF,MAAM,SAAS,GAAG,MAAM,MAAM,CAAC,WAAW,CAAC,WAAW,CAAC,cAAc,EAAE,CAAC,CAAA;IACxE,MAAM,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,EAAE,SAAS,EAAE,OAAO,EAAE,WAAW,EAAE,CAAC,CAAA;IAEjE,MAAM,OAAO,CAAC,GAAG,EAAE,KAAK,CAAC,CAAA;IACzB,OAAO,KAAK,CAAA;AACd,CAAC;AAfD,oCAeC","sourcesContent":["import { Wallet } from 'ethers'\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport { FastifyInstance, LightMyRequestResponse } from 'fastify'\nimport { SiweMessage } from 'siwe'\n\nexport async function getNonce(app: FastifyInstance) {\n  return app.inject({ method: 'POST', url: '/siwe/init', validate: true })\n}\n\nexport async function signIn(\n  app: FastifyInstance,\n  { signature, message }: { signature: string; message: SiweMessage }\n) {\n  return app.inject({ method: 'POST', url: '/siwe/signin', payload: { signature, message }, validate: true })\n}\n\nexport async function getAuth(app: FastifyInstance, token: string) {\n  return app.inject({\n    method: 'GET',\n    url: '/siwe/me',\n    validate: true,\n    cookies: {\n      __Host_auth_token: token,\n    },\n  })\n}\n\nexport function createAuthMessage(wallet: Wallet) {\n  return {\n    domain: 'localhost:3001',\n    address: wallet.address,\n    statement: 'Sign in with Ethereum to the app.',\n    uri: 'http://localhost:3001',\n    version: '1',\n    chainId: 1,\n  }\n}\n\nexport async function authenticate(wallet: Wallet, app: FastifyInstance) {\n  const nonceResponse = await getNonce(app)\n  const nonceResponseBody = JSON.parse(nonceResponse.body)\n  const message = createAuthMessage(wallet)\n\n  const siweMessage = new SiweMessage({\n    ...message,\n    nonce: nonceResponseBody.nonce,\n  })\n\n  const signature = await wallet.signMessage(siweMessage.prepareMessage())\n  const token = JSON.stringify({ signature, message: siweMessage })\n\n  await getAuth(app, token)\n  return token\n}\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"121ce4dfd922890d5263951a9cdc0b84100a7e8c","contentHash":"1c3344cf46fdeda9b9228d3fcafabd44d0e2565d015fe8c20146e9183a987d4a"}}